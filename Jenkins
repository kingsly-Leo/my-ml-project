pipeline {
  agent any

  environment {
    IMAGE = "your-dh-username/airline-ml"
    TAG = "${env.BUILD_NUMBER}"
    LATEST_TAG = "latest"
    CONTAINER = "airline-ml"
  }

  stages {
    stage('Checkout') { steps { checkout scm } }

    stage('Build') {
      steps { sh 'docker build -t $IMAGE:$TAG -t $IMAGE:$LATEST_TAG .' }
    }

    stage('Login') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-creds',
          usernameVariable: 'U', passwordVariable: 'P')]) {
          sh 'echo $P | docker login -u $U --password-stdin'
        }
      }
    }

    stage('Push') {
      steps {
        sh 'docker push $IMAGE:$TAG'
        sh 'docker push $IMAGE:$LATEST_TAG'
      }
    }

    stage('Deploy (same machine)') {
      steps {
        sh '''
          docker rm -f $CONTAINER || true
          docker run -d --name $CONTAINER -p 8000:8000 --restart unless-stopped $IMAGE:$LATEST_TAG
        '''
      }
    }
  }

  post { always { sh 'docker logout || true' } }
}
